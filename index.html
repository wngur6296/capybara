<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ê°•í•´ì ¸ë°”ë¼</title>
  <style>
    :root{
      --bg:#0e0e12;
      --card:rgba(255,255,255,.06);
      --stroke:rgba(255,255,255,.12);
      --shadow:rgba(0,0,0,.6);
      --gold:#f6c453;
      --dia:#6fd3ff;

      --hp:#44ff6a;
      --shield:#4aa3ff;
      --mh:#ff7b7b;

      --muted:rgba(255,255,255,.75);
      --danger:#ff4a4a;
      --ok:#4bff8c;
      --exp:#b88cff;

      --myth:#ff3a3a;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0; padding:0;
      background:var(--bg);
      color:#fff;
      font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
      -webkit-user-select:none; user-select:none;
      -webkit-touch-callout:none;
      touch-action:manipulation;
      padding-top: env(safe-area-inset-top);
      padding-bottom: env(safe-area-inset-bottom);
    }

    header{
      padding:14px 12px 4px;
      text-align:center;
      font-weight:1000;
      font-size:28px;
      letter-spacing:.5px;
      text-shadow:0 0 14px rgba(255,215,0,.35);
    }
    .sub{
      text-align:center;
      opacity:.78;
      font-size:12.5px;
      margin-bottom:10px;
    }

    .wrap{
      max-width:720px;
      margin:0 auto;
      padding:0 10px 92px;
    }

    .card{
      background:var(--card);
      border:1px solid var(--stroke);
      border-radius:16px;
      box-shadow:0 0 12px var(--shadow);
      padding:12px;
      margin:10px 0;
    }

    .row{display:flex; gap:10px; align-items:center; justify-content:space-between}
    .col{display:flex; flex-direction:column; gap:6px}
    .tiny{font-size:12px; opacity:.8}
    .mono{font-variant-numeric:tabular-nums}
    .pill{
      display:inline-flex; align-items:center; gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(0,0,0,.35);
      font-size:12.5px;
      max-width:100%;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .hud{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .statBox{
      padding:10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.30)
    }
    .statBox .k{opacity:.8; font-size:12px}
    .statBox .v{font-weight:1000; font-size:14px; margin-top:2px}
    .hud2{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }

    .expWrap{
      margin-top:10px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.28);
      border-radius:14px;
      padding:10px;
    }
    .expTop{
      display:flex; align-items:center; justify-content:space-between;
      font-size:12.5px;
      opacity:.9;
      margin-bottom:8px;
      gap:10px;
    }
    .bar{
      height:12px;
      border-radius:999px;
      background:rgba(255,255,255,.10);
      overflow:hidden;
      border:1px solid rgba(255,255,255,.10);
    }
    .fill{height:100%; width:0%; transition:width .22s ease}
    .fill.hp{background:var(--hp)}
    .fill.shield{background:var(--shield)}
    .fill.mh{background:var(--mh)}
    .fill.exp{background:var(--exp)}

    .battleArea{
      position:relative;
      overflow:hidden;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      min-height:240px;
      background:
        radial-gradient(1100px 420px at 50% 35%, rgba(75,255,140,.10), transparent 60%),
        linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.45));
    }
    .battleArea.boss{
      background:
        radial-gradient(1100px 420px at 50% 35%, rgba(255,80,80,.14), transparent 60%),
        radial-gradient(900px 380px at 60% 40%, rgba(255,215,0,.08), transparent 65%),
        linear-gradient(180deg, rgba(0,0,0,.0), rgba(0,0,0,.55));
    }

    .battleRow{
      width:100%;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding:12px 10px 8px;
    }

    .team{
      display:flex;
      align-items:flex-end;
      justify-content:center;
      gap:6px;
      flex: 1 1 auto;
      min-width:0;
    }

    .vs{
      flex:0 0 auto;
      font-weight:1000;
      opacity:.85;
      padding:0 4px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
      font-size:12.5px;
      white-space:nowrap;
    }

    .enemy{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:center;
      gap:6px;
      flex: 0 0 150px;
    }

    .spriteBox{
      position:relative;
      width:110px;
      height:110px;
      display:flex;
      align-items:center;
      justify-content:center;
      flex:0 0 auto;
    }
    .spriteBox.small{ width:56px; height:56px; }
    .spriteBox.enemy{ width:120px; height:120px; }

    img.sprite{
      width:100%;
      height:100%;
      object-fit:contain;
      display:block;
      filter:drop-shadow(0 8px 10px rgba(0,0,0,.55));
      transition:transform .18s;
    }

    .overlay{
      position:absolute;
      inset:0;
      pointer-events:none;
    }
    .overlay img{
      position:absolute;
      inset:0;
      width:100%;
      height:100%;
      object-fit:contain;
      filter:drop-shadow(0 6px 8px rgba(0,0,0,.45));
    }

    .petSlot{
      display:flex;
      flex-direction:column;
      align-items:center;
      justify-content:flex-end;
      gap:4px;
      width:64px;
      flex:0 0 64px;
    }
    .petLabel{
      font-size:11px;
      opacity:.85;
      text-align:center;
      max-width:64px;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }
    .lock{
      font-size:11px;
      opacity:.8;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(0,0,0,.35);
    }

    .mythAura{
      filter: drop-shadow(0 0 12px rgba(255,58,58,.65)) drop-shadow(0 0 22px rgba(255,58,58,.28));
      animation: mythPulse 1.6s ease-in-out infinite;
    }
    @keyframes mythPulse{
      0%,100%{ transform:translateY(0) scale(1.0); }
      50%{ transform:translateY(-1px) scale(1.03); }
    }

    .battleInfo{
      padding:0 10px 12px;
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .miniLine{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      flex-wrap:wrap;
    }
    .statusIcons{
      display:flex;
      gap:6px;
      flex-wrap:wrap;
      justify-content:flex-start;
      min-height:20px;
    }

    .btn{
      width:100%;
      border:0;
      border-radius:14px;
      padding:14px 12px;
      margin:8px 0 0;
      background:#1d1d24;
      color:#fff;
      font-weight:900;
      font-size:16px;
      box-shadow:0 0 10px rgba(0,0,0,.6);
    }
    .btn:active{transform:scale(.99)}
    .btnGold{background:rgba(246,196,83,.14); border:1px solid rgba(246,196,83,.28)}
    .btnDia{background:rgba(111,211,255,.14); border:1px solid rgba(111,211,255,.28)}
    .btnOk{background:rgba(75,255,140,.14); border:1px solid rgba(75,255,140,.26)}
    .btnDanger{background:rgba(255,74,74,.16); border:1px solid rgba(255,74,74,.28)}
    .muted{opacity:.75}

    .log{
      height:86px;
      overflow:hidden;
      background:rgba(0,0,0,.35);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:10px;
      font-size:13px;
      line-height:1.45;
      white-space:pre-line;
    }

    .tabbar{
      position:fixed;
      left:0; right:0; bottom:0;
      background:rgba(15,15,20,.92);
      border-top:1px solid rgba(255,255,255,.10);
      padding:10px 10px calc(12px + env(safe-area-inset-bottom));
      backdrop-filter: blur(10px);
    }
    .tabs{
      max-width:720px;
      margin:0 auto;
      display:flex;
      gap:10px;
    }
    .tab{
      flex:1;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(255,255,255,.06);
      color:#fff;
      padding:10px 8px;
      font-weight:1000;
      font-size:13px;
      display:flex;
      align-items:center;
      justify-content:center;
      gap:6px;
    }
    .tab.active{
      background:rgba(255,255,255,.12);
      border-color:rgba(255,255,255,.18);
    }

    .modalBack{
      position:fixed;
      inset:0;
      background:rgba(0,0,0,.65);
      display:none;
      align-items:center;
      justify-content:center;
      padding:14px;
      z-index:999;
    }
    .modal{
      width:min(560px, 100%);
      border-radius:16px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(20,20,28,.96);
      box-shadow:0 0 22px rgba(0,0,0,.75);
      padding:12px;
    }
    .modalHead{
      display:flex; align-items:center; justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .modalTitle{font-weight:1000}
    .xbtn{
      border:0;
      background:rgba(255,255,255,.08);
      color:#fff;
      border-radius:10px;
      padding:8px 10px;
      font-weight:900;
    }

    .shake{animation:shake .24s}
    @keyframes shake{
      0%{transform:translateX(0)}
      25%{transform:translateX(-8px)}
      50%{transform:translateX(8px)}
      75%{transform:translateX(-8px)}
      100%{transform:translateX(0)}
    }
    .dash{animation:dash .22s}
    @keyframes dash{
      0%{transform:translateX(0)}
      50%{transform:translateX(24px) scale(1.06)}
      100%{transform:translateX(0)}
    }
    .critText{
      position:absolute;
      left:50%; top:46%;
      transform:translate(-50%,-50%);
      font-size:34px;
      font-weight:1000;
      color:var(--gold);
      text-shadow:0 0 14px rgba(255,0,0,.55);
      opacity:0;
      pointer-events:none;
    }
    .showCrit{animation:critPop .7s ease-out}
    @keyframes critPop{
      0%{opacity:0; transform:translate(-50%,-50%) scale(.6)}
      30%{opacity:1; transform:translate(-50%,-50%) scale(1.35)}
      100%{opacity:0; transform:translate(-50%,-50%) scale(1.05)}
    }

    @media (max-width:420px){
      .enemy{flex-basis:140px}
      .spriteBox{width:102px;height:102px}
      .spriteBox.enemy{width:112px;height:112px}
      .petSlot{width:60px; flex-basis:60px}
      .spriteBox.small{width:52px;height:52px}
    }
  </style>
</head>

<body>
  <header>ê°•í•´ì ¸ë°”ë¼</header>
  <div class="sub">ì¹´í”¼ë°”ë¼ë¥¼ ê°•í•˜ê²Œ í‚¤ì›Œë´…ì‹œë‹¤!!!</div>

  <div class="wrap">

    <section id="screenBattle">

      <div class="card">
        <div class="hud">
          <div class="statBox">
            <div class="k">ë ˆë²¨</div>
            <div class="v"><span id="uiLv" class="mono">1</span> / 200</div>
          </div>
          <div class="statBox">
            <div class="k">ìŠ¤í…Œì´ì§€</div>
            <div class="v"><span id="uiStage" class="mono">1</span> Â· <span id="uiZone" class="mono">ì´ˆì›</span></div>
          </div>
          <div class="statBox" id="hudGoldBox">
            <div class="k">ê³¨ë“œ</div>
            <div class="v">ğŸ’° <span id="uiGold" class="mono">0</span></div>
          </div>
          <div class="statBox" id="hudDiaBox">
            <div class="k">ë‹¤ì´ì•„</div>
            <div class="v">ğŸ’ <span id="uiDia" class="mono">0</span></div>
          </div>
        </div>

        <div class="hud2">
          <span class="pill">ê³µê²©ë ¥ <b id="uiAtk" class="mono">0</b></span>
          <span class="pill">ì¹˜ëª… <b id="uiCrit" class="mono">0</b>%</span>
          <span class="pill">í”¼ê° <b id="uiDR" class="mono">0</b>%</span>
          <span class="pill">íšŒë³µí…œ <b id="uiHeals" class="mono">0</b></span>
        </div>

        <div class="expWrap">
          <div class="expTop">
            <div><b>EXP</b> <span id="uiExpPct" class="mono">0</span>%</div>
            <div class="mono"><span id="uiExp">0</span> / <span id="uiNeedExp">0</span></div>
          </div>
          <div class="bar"><div id="uiExpBar" class="fill exp" style="width:0%"></div></div>
        </div>
      </div>

      <div class="card battleArea" id="battleBg">
        <div class="battleRow">

          <div class="team" id="teamRow">
            <div class="petSlot" id="petSlot1"></div>

            <div class="col" style="align-items:center; gap:6px;">
              <div class="spriteBox" style="width:110px;height:110px;">
                <img id="playerImg" class="sprite" src="capybara.png" alt="capybara">
                <div class="overlay">
                  <img id="ovArmor" src="armor_overlay.png" alt="armor overlay" onerror="this.style.display='none'">
                  <img id="ovCos" src="cosmetic_overlay.png" alt="cos overlay" onerror="this.style.display='none'">
                  <img id="ovMouth" src="mouth_overlay.png" alt="mouth overlay" onerror="this.style.display='none'">
                </div>
              </div>
              <div class="tiny">ì¹´í”¼ë°”ë¼</div>
              <div class="statusIcons" id="uiPlayerIcons"></div>
            </div>

            <div class="petSlot" id="petSlot2"></div>
          </div>

          <div class="vs">âš” VS</div>

          <div class="enemy">
            <div class="spriteBox enemy">
              <img id="monsterImg" class="sprite" src="monster1.png" alt="monster">
            </div>
            <div class="tiny" id="uiMonsterName">í•˜ì°®ì€ ê°œêµ¬ë¦¬</div>
          </div>

        </div>

        <div class="battleInfo">
          <div class="miniLine">
            <div class="tiny">ëª¬ìŠ¤í„° HP <span id="uiMhp" class="mono">0</span> / <span id="uiMhpMax" class="mono">0</span></div>
            <div class="tiny" id="uiVariantTag"></div>
          </div>
          <div class="bar"><div id="uiMhpBar" class="fill mh" style="width:100%"></div></div>
          <div class="statusIcons" id="uiMonsterIcons"></div>

          <div class="miniLine">
            <div class="tiny">ğŸ›¡ ë³´í˜¸ë§‰ <span id="uiShieldTxt" class="mono">0</span>/<span id="uiShieldMaxTxt" class="mono">0</span></div>
            <div class="tiny">â¤ï¸ ì²´ë ¥ <span id="uiHpTxt" class="mono">0</span>/<span id="uiHpMaxTxt" class="mono">0</span></div>
          </div>
          <div class="bar"><div id="uiShieldBar" class="fill shield" style="width:0%"></div></div>
          <div class="bar"><div id="uiHpBar" class="fill hp" style="width:100%"></div></div>
        </div>

        <div id="critText" class="critText">CRITICAL!!</div>
      </div>

      <div class="card">
        <button class="btn btnOk" onclick="attack()">ğŸ‘Š ê³µê²©</button>
        <button class="btn" onclick="useHeal()">ğŸ– íšŒë³µ</button>
        <button class="btn muted" onclick="openReviveIfDead()">ğŸ’ ë¶€í™œ (ë‹¤ì´ì•„ 5) / ì‚¬ë§ ì‹œë§Œ ê°€ëŠ¥</button>

        <div class="tiny" style="margin-top:10px; opacity:.9;"><b>ì „íˆ¬ ë¡œê·¸</b> (ë¯¸ë‹ˆ)</div>
        <div id="log" class="log"></div>
      </div>

    </section>

    <section id="screenShop" style="display:none;"></section>
    <section id="screenWarehouse" style="display:none;">
      <div class="card">
        <div style="font-weight:1000; font-size:15px;">ì°½ê³ </div>
        <div class="tiny">Part3ì—ì„œ í«/ì¥ë¹„/ì¹˜ì¥/ê°•í™”/ì‹ í™” ì§„í™” ë¶™ì¸ë‹¤</div>
      </div>
    </section>

    <section id="screenSettings" style="display:none;">
      <div class="card">
        <div style="font-weight:1000; font-size:15px;">ì„¤ì •</div>
        <div class="tiny">BGM/íš¨ê³¼ìŒ/ì´ˆê¸°í™”</div>
      </div>

      <div class="card">
        <div class="row">
          <div class="col"><div style="font-weight:1000;">ğŸµ BGM</div></div>
          <button class="btn" style="margin:0; width:auto; padding:10px 14px;" onclick="toggleBgm()" id="btnBgm">ON</button>
        </div>
        <div class="row" style="margin-top:10px;">
          <div class="col"><div style="font-weight:1000;">ğŸ”Š íš¨ê³¼ìŒ</div></div>
          <button class="btn" style="margin:0; width:auto; padding:10px 14px;" onclick="toggleSfx()" id="btnSfx">ON</button>
        </div>
      </div>

      <div class="card">
        <div style="font-weight:1000;">ì´ˆê¸°í™”</div>
        <div class="tiny muted">ëª¨ë“  ë°ì´í„° ì‚­ì œ (ë˜ëŒë¦¬ê¸° ë¶ˆê°€)</div>
        <button class="btn btnDanger" onclick="hardReset()">â˜  ì „ì²´ ì´ˆê¸°í™”</button>
      </div>
    </section>

  </div>

  <div class="tabbar">
    <div class="tabs">
      <button class="tab active" id="tabBattle" onclick="showScreen('battle')">âš” ì „íˆ¬</button>
      <button class="tab" id="tabShop" onclick="showScreen('shop')">ğŸ›’ ìƒì </button>
      <button class="tab" id="tabWh" onclick="showScreen('warehouse')">ğŸ’ ì°½ê³ </button>
      <button class="tab" id="tabSet" onclick="showScreen('settings')">âš™ ì„¤ì •</button>
    </div>
  </div>

  <div class="modalBack" id="modalBack">
    <div class="modal">
      <div class="modalHead">
        <div class="modalTitle" id="modalTitle">ì•Œë¦¼</div>
        <button class="xbtn" onclick="closeModal()">ë‹«ê¸°</button>
      </div>
      <div id="modalBody" class="tiny" style="white-space:pre-wrap; line-height:1.55;"></div>
      <div id="modalActions" style="margin-top:10px;"></div>
    </div>
  </div>

<script>
/* ===== Safari ë”ë¸”íƒ­ í™•ëŒ€ ë°©ì§€ ===== */
let lastTouchEnd = 0;
document.addEventListener('touchend', function (event) {
  const now = (new Date()).getTime();
  if (now - lastTouchEnd <= 300) event.preventDefault();
  lastTouchEnd = now;
}, false);

/* ===== ì—ëŸ¬ë¥¼ ë¡œê·¸ì— ì°ì–´ì„œ â€œë©ˆì¶¤â€ ì›ì¸ ì¦‰ì‹œ ë³´ì´ê²Œ ===== */
window.addEventListener("error", (e)=>{
  try{
    logMini("âš  JSì—ëŸ¬: " + (e.message || "unknown"));
  }catch(_){}
});

/* ===== ì˜¤ë””ì˜¤ ===== */
let audioCtx = null;
let bgmTimer = null;
const settings = { bgmEnabled:true, sfxEnabled:true };

function initAudio(){ if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)(); }
function beep(freq=440, dur=0.08, type="square", vol=0.18){
  if(!settings.sfxEnabled) return;
  initAudio();
  const osc = audioCtx.createOscillator();
  const gain = audioCtx.createGain();
  osc.type = type; osc.frequency.value = freq;
  gain.gain.value = vol;
  osc.connect(gain); gain.connect(audioCtx.destination);
  osc.start(); osc.stop(audioCtx.currentTime + dur);
}
function sfxHit(){ beep(250,.06,"square",.22); }
function sfxCrit(){ beep(1100,.09,"sawtooth",.22); }
function sfxLvl(){ beep(650,.12,"triangle",.18); setTimeout(()=>beep(950,.12,"triangle",.18),140); }
function startBgm(){
  initAudio();
  if(bgmTimer) return;
  const notes=[220,277,330,392,440,392,330,277];
  let i=0;
  bgmTimer=setInterval(()=>{
    if(!settings.bgmEnabled) return;
    initAudio();
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    osc.type="triangle"; osc.frequency.value=notes[i];
    gain.gain.value=0.055;
    osc.connect(gain); gain.connect(audioCtx.destination);
    osc.start(); osc.stop(audioCtx.currentTime + 0.12);
    i=(i+1)%notes.length;
  },180);
}
function toggleBgm(){ settings.bgmEnabled=!settings.bgmEnabled; saveSettings(); renderSettingsButtons(); logMini(settings.bgmEnabled?"ğŸµ BGM ON":"ğŸ”‡ BGM OFF"); if(settings.bgmEnabled) startBgm(); }
function toggleSfx(){ settings.sfxEnabled=!settings.sfxEnabled; saveSettings(); renderSettingsButtons(); logMini(settings.sfxEnabled?"ğŸ”Š SFX ON":"ğŸ”‡ SFX OFF"); }
function renderSettingsButtons(){
  document.getElementById("btnBgm").textContent = settings.bgmEnabled ? "ON" : "OFF";
  document.getElementById("btnSfx").textContent = settings.sfxEnabled ? "ON" : "OFF";
}

/* ===== ì €ì¥/ë¡œë“œ ===== */
const SAVE_VERSION = 9;
const SAVE_KEY_MAIN = "capy_save_main_v9";
const SAVE_KEY_BACK = "capy_save_backup_v9";
const SETTINGS_KEY = "capy_settings_v9";

function saveSettings(){ localStorage.setItem(SETTINGS_KEY, JSON.stringify({v:SAVE_VERSION, settings})); }
function loadSettings(){
  try{
    const raw = localStorage.getItem(SETTINGS_KEY);
    if(!raw) return;
    const obj = JSON.parse(raw);
    if(obj?.settings){
      settings.bgmEnabled = !!obj.settings.bgmEnabled;
      settings.sfxEnabled = !!obj.settings.sfxEnabled;
    }
  }catch(e){}
}

function clone(obj){ return JSON.parse(JSON.stringify(obj)); }
function clamp(v,min,max){ return Math.max(min, Math.min(max, v)); }
function randi(a,b){ return Math.floor(Math.random()*(b-a+1))+a; }
function chance(p){ return Math.random()*100 < p; }

function validateSave(obj){
  return !!(obj && obj.version===SAVE_VERSION && obj.player && obj.monster);
}
function saveGame(){
  try{
    const mainRaw = localStorage.getItem(SAVE_KEY_MAIN);
    if(mainRaw) localStorage.setItem(SAVE_KEY_BACK, mainRaw);
    state.t = Date.now();
    state.settings = clone(settings);
    localStorage.setItem(SAVE_KEY_MAIN, JSON.stringify(state));
  }catch(e){
    logMini("âš  ì €ì¥ ì‹¤íŒ¨");
  }
}
function loadGame(){
  try{
    const main = localStorage.getItem(SAVE_KEY_MAIN);
    if(main){
      const obj = JSON.parse(main);
      if(validateSave(obj)) return obj;
    }
  }catch(e){}
  try{
    const back = localStorage.getItem(SAVE_KEY_BACK);
    if(back){
      const obj = JSON.parse(back);
      if(validateSave(obj)){
        logMini("ğŸ›Ÿ ë°±ì—… ë³µêµ¬");
        return obj;
      }
    }
  }catch(e){}
  return null;
}
let autosaveTimer=null;
function autoSave(){
  if(autosaveTimer) clearTimeout(autosaveTimer);
  autosaveTimer=setTimeout(()=>saveGame(), 220);
}

/* ===== ë¡œê·¸ ===== */
const LOG_MAX_LINES = 4;
function logMini(msg){
  const el = document.getElementById("log");
  const lines = (el.textContent || "").split("\n").filter(Boolean);
  lines.push(msg);
  while(lines.length > LOG_MAX_LINES) lines.shift();
  el.textContent = lines.join("\n");
}

/* ===== ì§€ì—­/ëª¬ìŠ¤í„° ===== */
const MAX_LEVEL = 200;
function zoneName(stage){
  if(stage<=20) return "ì´ˆì›";
  if(stage<=40) return "ìˆ²";
  if(stage<=60) return "í™©ì•¼";
  if(stage<=80) return "ì„¤ì›";
  if(stage<=100) return "í™”ì‚°";
  if(stage<=140) return "ì•”í‘ì§€ëŒ€";
  if(stage<=180) return "ì²œê³µ";
  return "ì¢…ë§ì˜ ë•…";
}
function isBossStage(stage){ return stage % 10 === 0; }
function rollVariant(){
  if(!chance(5)) return {type:"none", mult:1, tag:""};
  if(chance(20)) return {type:"gold", mult:2, tag:"â­ í™©ê¸ˆ ë³€ì¢…"};
  return {type:"elite", mult:2, tag:"â­ ë³€ì¢…"};
}

/* ===== ìƒíƒœ ===== */
let state = null;

function newGameState(){
  return {
    version: SAVE_VERSION,
    t: Date.now(),
    player: {
      level:1,
      exp:0,
      needExp:20,
      stage:1,
      baseAtk:5,
      baseMaxHp:100,
      hp:100,
      shield:0,
      shieldMax:0,
      gold:300,
      dia:10,
      healItems:0,
      equip: { weaponR:null, weaponL:null, weaponM:null, armor:null, cosmetic:null },
      statuses: [],
      pets: [ null, null ],
    },
    monster: {
      boss:false,
      name:"í•˜ì°®ì€ ê°œêµ¬ë¦¬",
      img:"monster1.png",
      maxHp:60,
      hp:60,
      atk:6,
      variant: {type:"none", mult:1, tag:""},
      statuses: []
    },
    settings: clone(settings),
  };
}

/* ===== ëŠ¥ë ¥ì¹˜ ===== */
function getTotalAtk(){ return state.player.baseAtk; }
function getTotalMaxHp(){ return state.player.baseMaxHp; }
function getDamageReduce(){ return 0; }
function getCritChance(){ return 5; }

function spawnMonster(stage){
  const boss = isBossStage(stage);
  const v = rollVariant();
  if(boss){
    return { boss:true, name:"ğŸ‰ ë³´ìŠ¤ ë“œë˜ê³¤", img:"boss.png", maxHp: 80 + stage*10, hp: 80 + stage*10, atk: 8 + Math.floor(stage*1.2), variant:v, statuses:[] };
  }
  const pool = [
    { name:"í•˜ì°®ì€ ê°œêµ¬ë¦¬", img:"monster1.png" },
    { name:"ì¡°ê¸ˆ ìˆ í† ë¼", img:"monster2.png" },
    { name:"ë§›ìˆëŠ” ì†Œ", img:"monster3.png" },
  ];
  const pick = pool[Math.floor(Math.random()*pool.length)];
  const baseHp = 55 + stage*7;
  return { boss:false, name: pick.name, img: pick.img, maxHp: Math.floor(baseHp*v.mult), hp: Math.floor(baseHp*v.mult), atk: Math.floor((6 + stage*0.9)*v.mult*0.9), variant:v, statuses:[] };
}

function setMonster(stage){
  state.monster = spawnMonster(stage);

  const bg = document.getElementById("battleBg");
  bg.classList.toggle("boss", !!state.monster.boss);

  document.getElementById("monsterImg").src = state.monster.img;
  document.getElementById("uiMonsterName").textContent = state.monster.name;

  document.getElementById("uiVariantTag").textContent = state.monster.variant?.tag || "";
  autoSave();
}

/* ===== í« ë Œë”(ì•ˆì „) ===== */
function renderPets(){
  const p = state.player;
  const s1 = document.getElementById("petSlot1");
  const s2 = document.getElementById("petSlot2");
  s1.innerHTML = "";
  s2.innerHTML = "";

  const unlocked1 = p.level >= 20;
  const unlocked2 = p.level >= 80;

  const mount = (slotEl, pet, unlocked, lockText)=>{
    if(!unlocked){
      slotEl.innerHTML = `<div class="lock">ğŸ”’ ${lockText}</div>`;
      return;
    }
    if(!pet) return;

    const box = document.createElement("div");
    box.className = "spriteBox small";
    const img = document.createElement("img");
    img.className = "sprite" + (pet.isMythic ? " mythAura" : "");
    img.src = pet.img || "pet1.png";
    img.alt = pet.name || "pet";
    img.onerror = ()=>{ img.style.display="none"; };
    box.appendChild(img);

    const label = document.createElement("div");
    label.className = "petLabel";
    label.textContent = pet.name || "í«";

    slotEl.appendChild(box);
    slotEl.appendChild(label);
  };

  mount(s1, p.pets[0], unlocked1, "Lv20 í•´ê¸ˆ");
  mount(s2, p.pets[1], unlocked2, "Lv80 í•´ê¸ˆ");
}

/* ===== ì˜¤ë²„ë ˆì´ í‘œì‹œ(ì¥ì°© ì—†ìœ¼ë©´ ìˆ¨ê¹€) ===== */
function updateOverlays(){
  const p = state.player;
  const ovArmor=document.getElementById("ovArmor");
  const ovCos=document.getElementById("ovCos");
  const ovMouth=document.getElementById("ovMouth");

  ovArmor.style.display = p.equip?.armor ? "block" : "none";
  ovCos.style.display   = p.equip?.cosmetic ? "block" : "none";
  ovMouth.style.display = (p.level>=80 && p.equip?.weaponM) ? "block" : "none";
}
function renderStatusIcons(){
  document.getElementById("uiPlayerIcons").innerHTML="";
  document.getElementById("uiMonsterIcons").innerHTML="";
}

/* ===== í™”ë©´ ì „í™˜ ===== */
function showScreen(name){
  const screens={
    battle:document.getElementById("screenBattle"),
    shop:document.getElementById("screenShop"),
    warehouse:document.getElementById("screenWarehouse"),
    settings:document.getElementById("screenSettings"),
  };
  for(const k in screens) screens[k].style.display=(k===name)?"block":"none";
  document.getElementById("tabBattle").classList.toggle("active", name==="battle");
  document.getElementById("tabShop").classList.toggle("active", name==="shop");
  document.getElementById("tabWh").classList.toggle("active", name==="warehouse");
  document.getElementById("tabSet").classList.toggle("active", name==="settings");
}

/* ===== í†µí™” ì „íˆ¬ ìˆ¨ê¹€ (ìƒì ì—ì„œë§Œ í‘œì‹œ) ===== */
const uiPrefs = { hideCurrencyInBattle: true };
function applyCurrencyVisibility(){
  const battleOn = (document.getElementById("screenBattle").style.display !== "none");
  const hide = uiPrefs.hideCurrencyInBattle && battleOn;
  const g = document.getElementById("hudGoldBox");
  const d = document.getElementById("hudDiaBox");
  if(g) g.style.display = hide ? "none" : "";
  if(d) d.style.display = hide ? "none" : "";
}

/* ===== EXP ì»¤ë¸Œ ===== */
function nextNeedExp(currentNeed, nextLevel){
  if(nextLevel < 20) return Math.floor(currentNeed*1.16 + 10);
  if(nextLevel < 60) return Math.floor(currentNeed*1.11 + 14);
  if(nextLevel < 120) return Math.floor(currentNeed*1.14 + 18);
  return Math.floor(currentNeed*1.17 + 22);
}

/* ===== ëª¨ë‹¬ ===== */
function showModal(title, body, actions=[]){
  document.getElementById("modalTitle").textContent=title;
  document.getElementById("modalBody").textContent=body;
  const act=document.getElementById("modalActions");
  act.innerHTML="";
  for(const a of actions){
    const b=document.createElement("button");
    b.className="btn";
    b.textContent=a.text;
    if(a.danger) b.classList.add("btnDanger");
    if(a.ok) b.classList.add("btnOk");
    if(a.disabled){
      b.style.opacity=.5;
      b.onclick=()=>{};
    }else{
      b.onclick=()=>a.fn?.();
    }
    act.appendChild(b);
  }
  document.getElementById("modalBack").style.display="flex";
}
function closeModal(){ document.getElementById("modalBack").style.display="none"; }

/* ===== ìƒì /ì¶œì„ ===== */
const DAILY_KEY = "capy_daily_v9";

function todayKey(){
  const d = new Date();
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,"0");
  const da=String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${da}`;
}
function getDaily(){
  try{
    const raw = localStorage.getItem(DAILY_KEY);
    if(!raw) return {last:"", streak:0, tickets:{gear:0, cos:0, heal:0}, revive:0};
    const obj = JSON.parse(raw);
    return Object.assign({last:"", streak:0, tickets:{gear:0, cos:0, heal:0}, revive:0}, obj);
  }catch(e){
    return {last:"", streak:0, tickets:{gear:0, cos:0, heal:0}, revive:0};
  }
}
function setDaily(d){ localStorage.setItem(DAILY_KEY, JSON.stringify(d)); }

function dailyRewards(day){
  if(day===1) return {dia:5,  ticketHeal:1, msg:"ğŸ’5 + íšŒë³µê°€ì± ê¶Œ1"};
  if(day===2) return {dia:8,  ticketGear:1, msg:"ğŸ’8 + ì¥ë¹„ê°€ì± ê¶Œ1"};
  if(day===3) return {dia:10, revive:1,    msg:"ğŸ’10 + ë¶€í™œê¶Œ1"};
  if(day===4) return {dia:12, ticketCos:1, msg:"ğŸ’12 + ì¹˜ì¥ê°€ì± ê¶Œ1"};
  if(day===5) return {dia:15, ticketHeal:2,msg:"ğŸ’15 + íšŒë³µê°€ì± ê¶Œ2"};
  if(day===6) return {dia:20, ticketGear:1, ticketCos:1, msg:"ğŸ’20 + ì¥ë¹„ê¶Œ1 + ì¹˜ì¥ê¶Œ1"};
  return {dia:25, ticketGear:1, msg:"ğŸ’25 + ì „ì„¤í™•ì •ê¶Œ(ì¥ë¹„) (Part3)"};
}

function claimDaily(){
  const d = getDaily();
  const t = todayKey();
  if(d.last === t){
    showModal("ì¶œì„ì²´í¬","ì˜¤ëŠ˜ì€ ì´ë¯¸ ë°›ì•˜ìŠµë‹ˆë‹¤!",[{text:"í™•ì¸", fn:()=>closeModal()}]);
    return;
  }
  const prev = new Date();
  prev.setDate(prev.getDate()-1);
  const py=prev.getFullYear(), pm=String(prev.getMonth()+1).padStart(2,"0"), pda=String(prev.getDate()).padStart(2,"0");
  const yKey = `${py}-${pm}-${pda}`;

  if(d.last !== yKey) d.streak = 0;
  d.streak += 1;
  if(d.streak > 7) d.streak = 1;

  const r = dailyRewards(d.streak);

  state.player.dia += (r.dia||0);
  if(r.revive) d.revive += r.revive;
  if(r.ticketGear) d.tickets.gear += r.ticketGear;
  if(r.ticketCos) d.tickets.cos += r.ticketCos;
  if(r.ticketHeal) d.tickets.heal += r.ticketHeal;

  d.last = t;
  setDaily(d);

  logMini(`ğŸ“… ì¶œì„ ${d.streak}ì¼ì°¨: ${r.msg}`);
  showModal("ì¶œì„ì²´í¬",`âœ… ${d.streak}ì¼ì°¨ ë³´ìƒ\n${r.msg}`,[{text:"í™•ì¸", fn:()=>{closeModal(); render(); autoSave();}}]);
}

function ensureShopMarkup(){
  const shop = document.getElementById("screenShop");
  if(!shop) return;
  if(shop.dataset.ready === "1") return;

  shop.innerHTML = `
    <div class="card">
      <div style="font-weight:1000; font-size:15px;">ìƒì </div>
      <div class="tiny">ê³¨ë“œ/ë‹¤ì´ì•„ëŠ” ìƒì ì—ì„œë§Œ í™•ì¸ ê°€ëŠ¥</div>
      <div style="margin-top:10px; display:flex; gap:10px; flex-wrap:wrap;">
        <span class="pill">ğŸ’° ê³¨ë“œ <b id="shopGold" class="mono">0</b></span>
        <span class="pill">ğŸ’ ë‹¤ì´ì•„ <b id="shopDia" class="mono">0</b></span>
        <span class="pill">ğŸŸ ì¥ë¹„ê¶Œ <b id="tGear" class="mono">0</b></span>
        <span class="pill">ğŸŸ ì¹˜ì¥ê¶Œ <b id="tCos" class="mono">0</b></span>
        <span class="pill">ğŸŸ íšŒë³µê¶Œ <b id="tHeal" class="mono">0</b></span>
        <span class="pill">ğŸª½ ë¶€í™œê¶Œ <b id="tRevive" class="mono">0</b></span>
      </div>
      <button class="btn btnOk" onclick="claimDaily()">ğŸ“… ì¶œì„ì²´í¬ ë°›ê¸°</button>
    </div>

    <div class="card">
      <div style="font-weight:1000;">ğŸ§´ íšŒë³µí…œ ê°€ì±  (ê³¨ë“œ)</div>
      <div class="tiny">ëœë¤ìœ¼ë¡œ íšŒë³µí…œ 3~7ê°œ íšë“</div>
      <div style="display:flex; gap:10px;">
        <button class="btn btnGold" style="flex:1;" onclick="pullHealGacha(1)">ğŸ’° 1íšŒ (1000)</button>
        <button class="btn btnGold" style="flex:1;" onclick="pullHealGacha(10)">ğŸ’° 10íšŒ (10000)</button>
      </div>
      <button class="btn" onclick="useTicket('heal')">ğŸŸ íšŒë³µê°€ì± ê¶Œ ì‚¬ìš© (1)</button>
    </div>

    <div class="card">
      <div style="font-weight:1000;">ğŸ° ì¥ë¹„ ê°€ì±  (ê³¨ë“œ)</div>
      <div class="tiny">Part3ì—ì„œ ì‹¤ì œ ì¸ë²¤ ì§€ê¸‰</div>
      <div style="display:flex; gap:10px;">
        <button class="btn btnGold" style="flex:1;" onclick="pullGearGacha(1)">ğŸ’° 1íšŒ (200)</button>
        <button class="btn btnGold" style="flex:1;" onclick="pullGearGacha(10)">ğŸ’° 10íšŒ (2000)</button>
      </div>
      <button class="btn" onclick="useTicket('gear')">ğŸŸ ì¥ë¹„ê°€ì± ê¶Œ ì‚¬ìš© (1)</button>
    </div>

    <div class="card">
      <div style="font-weight:1000;">âœ¨ ì¹˜ì¥ ê°€ì±  (ë‹¤ì´ì•„)</div>
      <div class="tiny">Part3ì—ì„œ ì‹¤ì œ ì¸ë²¤ ì§€ê¸‰</div>
      <div style="display:flex; gap:10px;">
        <button class="btn btnDia" style="flex:1;" onclick="pullCosGacha(1)">ğŸ’ 1íšŒ (5)</button>
        <button class="btn btnDia" style="flex:1;" onclick="pullCosGacha(10)">ğŸ’ 10íšŒ (50)</button>
      </div>
      <button class="btn" onclick="useTicket('cos')">ğŸŸ ì¹˜ì¥ê°€ì± ê¶Œ ì‚¬ìš© (1)</button>
    </div>
  `;
  shop.dataset.ready = "1";
}

function renderShop(){
  ensureShopMarkup();
  const d = getDaily();
  document.getElementById("shopGold").textContent = state.player.gold;
  document.getElementById("shopDia").textContent  = state.player.dia;
  document.getElementById("tGear").textContent    = d.tickets.gear;
  document.getElementById("tCos").textContent     = d.tickets.cos;
  document.getElementById("tHeal").textContent    = d.tickets.heal;
  document.getElementById("tRevive").textContent  = d.revive;
}

function pullHealGacha(count){
  const p = state.player;
  const cost = 1000 * count;
  if(p.gold < cost){ logMini("âŒ ê³¨ë“œ ë¶€ì¡±"); return; }
  p.gold -= cost;

  let total = 0;
  for(let i=0;i<count;i++) total += randi(3,7);
  p.healItems += total;

  logMini(`ğŸ§´ íšŒë³µê°€ì±  +${total} (x${count})`);
  showModal("íšŒë³µê°€ì± ",`âœ… íšŒë³µí…œ ${total}ê°œ íšë“!`,[{text:"í™•ì¸", fn:()=>closeModal()}]);
  render(); autoSave();
}

function useTicket(kind){
  const d = getDaily();
  if(kind==="heal"){
    if(d.tickets.heal<=0){ logMini("âŒ íšŒë³µê¶Œ ì—†ìŒ"); return; }
    d.tickets.heal -= 1;
    setDaily(d);
    const got = randi(3,7);
    state.player.healItems += got;
    logMini(`ğŸŸ íšŒë³µê¶Œ ì‚¬ìš© +${got}`);
    showModal("íšŒë³µê¶Œ",`âœ… íšŒë³µí…œ ${got}ê°œ íšë“!`,[{text:"í™•ì¸", fn:()=>closeModal()}]);
  }
  if(kind==="gear"){
    if(d.tickets.gear<=0){ logMini("âŒ ì¥ë¹„ê¶Œ ì—†ìŒ"); return; }
    d.tickets.gear -= 1;
    setDaily(d);
    logMini("ğŸŸ ì¥ë¹„ê¶Œ ì‚¬ìš© (Part3ì—ì„œ ì¸ë²¤ ì§€ê¸‰)");
    showModal("ì¥ë¹„ê¶Œ",`âœ… ì¥ë¹„ 1ê°œ íšë“! (Part3ì—ì„œ ì°½ê³  í™•ì¸)`,[{text:"í™•ì¸", fn:()=>closeModal()}]);
  }
  if(kind==="cos"){
    if(d.tickets.cos<=0){ logMini("âŒ ì¹˜ì¥ê¶Œ ì—†ìŒ"); return; }
    d.tickets.cos -= 1;
    setDaily(d);
    logMini("ğŸŸ ì¹˜ì¥ê¶Œ ì‚¬ìš© (Part3ì—ì„œ ì¸ë²¤ ì§€ê¸‰)");
    showModal("ì¹˜ì¥ê¶Œ",`âœ… ì¹˜ì¥ 1ê°œ íšë“! (Part3ì—ì„œ ì°½ê³  í™•ì¸)`,[{text:"í™•ì¸", fn:()=>closeModal()}]);
  }
  renderShop(); render(); autoSave();
}

function pullGearGacha(count){
  const p = state.player;
  const cost = 200 * count;
  if(p.gold < cost){ logMini("âŒ ê³¨ë“œ ë¶€ì¡±"); return; }
  p.gold -= cost;
  logMini(`ğŸ° ì¥ë¹„ê°€ì±  x${count} (Part3ì—ì„œ ì¸ë²¤ ì§€ê¸‰)`);
  showModal("ì¥ë¹„ê°€ì± ",`âœ… ì¥ë¹„ ${count}ê°œ íšë“! (Part3ì—ì„œ ì°½ê³  í™•ì¸)`,[{text:"í™•ì¸", fn:()=>closeModal()}]);
  renderShop(); render(); autoSave();
}

function pullCosGacha(count){
  const p = state.player;
  const cost = 5 * count;
  if(p.dia < cost){ logMini("âŒ ë‹¤ì´ì•„ ë¶€ì¡±"); return; }
  p.dia -= cost;
  logMini(`âœ¨ ì¹˜ì¥ê°€ì±  x${count} (Part3ì—ì„œ ì¸ë²¤ ì§€ê¸‰)`);
  showModal("ì¹˜ì¥ê°€ì± ",`âœ… ì¹˜ì¥ ${count}ê°œ íšë“! (Part3ì—ì„œ ì°½ê³  í™•ì¸)`,[{text:"í™•ì¸", fn:()=>closeModal()}]);
  renderShop(); render(); autoSave();
}

/* ===== UI ë Œë” ===== */
function render(){
  const p=state.player, m=state.monster;

  document.getElementById("uiLv").textContent = p.level;
  document.getElementById("uiStage").textContent = p.stage;
  document.getElementById("uiZone").textContent = zoneName(p.stage);
  document.getElementById("uiGold").textContent = p.gold;
  document.getElementById("uiDia").textContent = p.dia;

  const atk=getTotalAtk(), crit=getCritChance(), dr=getDamageReduce();
  document.getElementById("uiAtk").textContent = atk;
  document.getElementById("uiCrit").textContent = crit;
  document.getElementById("uiDR").textContent = dr;
  document.getElementById("uiHeals").textContent = p.healItems;

  const pct = (p.needExp>0) ? Math.floor((p.exp/p.needExp)*100) : 0;
  document.getElementById("uiExpPct").textContent = clamp(pct,0,100);
  document.getElementById("uiExp").textContent = p.exp;
  document.getElementById("uiNeedExp").textContent = p.needExp;
  document.getElementById("uiExpBar").style.width = `${clamp((p.needExp>0?(p.exp/p.needExp)*100:0),0,100)}%`;

  const maxHp=getTotalMaxHp();
  p.hp = clamp(p.hp, 0, maxHp);
  document.getElementById("uiHpTxt").textContent = p.hp;
  document.getElementById("uiHpMaxTxt").textContent = maxHp;
  document.getElementById("uiHpBar").style.width = `${clamp((p.hp/maxHp)*100,0,100)}%`;

  document.getElementById("uiShieldTxt").textContent = Math.floor(p.shield);
  document.getElementById("uiShieldMaxTxt").textContent = Math.floor(p.shieldMax);
  const spPct=(p.shieldMax>0)?(p.shield/p.shieldMax)*100:0;
  document.getElementById("uiShieldBar").style.width = `${clamp(spPct,0,100)}%`;

  document.getElementById("uiMhp").textContent = m.hp;
  document.getElementById("uiMhpMax").textContent = m.maxHp;
  document.getElementById("uiMhpBar").style.width = `${clamp((m.hp/m.maxHp)*100,0,100)}%`;

  renderPets();
  updateOverlays();
  renderStatusIcons();
  renderSettingsButtons();
  applyCurrencyVisibility();

  const shopVisible = (document.getElementById("screenShop").style.display !== "none");
  if(shopVisible) renderShop();
}

/* ===== ì „íˆ¬ ===== */
function showCrit(){
  const el=document.getElementById("critText");
  el.classList.remove("showCrit"); void el.offsetWidth;
  el.classList.add("showCrit");
}
function dealToPlayer(raw){
  const p=state.player;
  const dr=getDamageReduce()/100;
  let dmg=Math.floor(raw*(1-dr));
  if(dmg<1) dmg=1;
  dmg=Math.min(dmg, Math.max(1, Math.floor(p.hp*0.95)));

  let shieldLost=0, hpLost=0;
  if(p.shield>0){
    const sUse=Math.min(p.shield, dmg);
    p.shield-=sUse; dmg-=sUse; shieldLost=sUse;
  }
  if(dmg>0){ p.hp-=dmg; hpLost=dmg; }
  return {shieldLost, hpLost};
}

function attack(){
  const p=state.player, m=state.monster;
  if(p.hp<=0){ logMini("â˜  ì‚¬ë§ ìƒíƒœ"); render(); return; }

  const pImg=document.getElementById("playerImg");
  const mImg=document.getElementById("monsterImg");
  pImg.classList.add("dash"); mImg.classList.add("shake");
  setTimeout(()=>pImg.classList.remove("dash"),240);
  setTimeout(()=>mImg.classList.remove("shake"),240);

  sfxHit();
  let dmg=getTotalAtk();
  const isCrit=chance(getCritChance());
  if(isCrit){ dmg=Math.floor(dmg*2.0); showCrit(); sfxCrit(); logMini(`ğŸ’¥ ì¹˜ëª… -${dmg}`); }
  else logMini(`ğŸ‘Š ê³µê²© -${dmg}`);

  m.hp=clamp(m.hp-dmg,0,m.maxHp);

  if(m.hp<=0){
    onWin();
    render(); autoSave();
    return;
  }

  const r = dealToPlayer(m.atk);
  logMini(`ğŸŸ¥ í”¼í•´ -${r.hpLost} ğŸŸ¦-${r.shieldLost}`);

  if(p.hp<=0) onDeath();
  render(); autoSave();
}

function onWin(){
  const p=state.player;
  const m=state.monster;

  const isBoss = !!m.boss;
  const mult = (m.variant?.mult || 1);

  let gainGold = Math.floor((14 + p.stage*3.8) * mult);
  let gainExp  = Math.floor((12 + p.stage*2.8) * mult);

  if(isBoss){
    gainGold = Math.floor(gainGold * 2.6);
    gainExp  = Math.floor(gainExp  * 2.0);
  }

  const heals = randi(3,7);

  p.exp += gainExp;
  p.gold += gainGold;
  p.healItems += heals;

  let diaP = isBoss ? 20 : 8;
  if(mult>=2) diaP += 5;
  if(chance(diaP)){
    const plus = isBoss ? 2 : 1;
    p.dia += plus;
    logMini(`ğŸ’ +${plus}`);
  }

  logMini(`ğŸ† ìŠ¹ë¦¬ +EXP${gainExp} +G${gainGold} +ğŸ§´${heals}`);

  while(p.exp>=p.needExp && p.level<MAX_LEVEL){
    p.exp -= p.needExp;
    p.level += 1;
    p.needExp = nextNeedExp(p.needExp, p.level);

    p.baseMaxHp += 16;
    p.baseAtk += 2;
    p.hp = clamp(p.hp + Math.floor(getTotalMaxHp()*0.15), 0, getTotalMaxHp());
    sfxLvl();
    logMini(`ğŸ“ˆ Lv${p.level}`);
  }

  p.stage += 1;
  setMonster(p.stage);
}

function useHeal(){
  const p=state.player;
  if(p.hp<=0){ logMini("â˜  íšŒë³µ ë¶ˆê°€"); return; }
  if(p.healItems<=0){ logMini("âŒ íšŒë³µí…œ ì—†ìŒ"); return; }
  p.healItems -= 1;
  const heal = Math.max(1, Math.floor(getTotalMaxHp()*0.35));
  p.hp = clamp(p.hp + heal, 0, getTotalMaxHp());
  logMini(`ğŸ– íšŒë³µ +${heal}`);
  autoSave(); render();
}

/* ===== ì£½ìŒ/ë¶€í™œ ===== */
function onDeath(){
  logMini("â˜  ì‚¬ë§");
  showDeathModal();
  autoSave();
}
function openReviveIfDead(){
  if(state.player.hp>0){ logMini("ë¶€í™œì€ ì‚¬ë§ ì‹œë§Œ"); return; }
  showDeathModal();
}
function showDeathModal(){
  const p=state.player;
  showModal("ì‚¬ë§", "ë¶€í™œ: ğŸ’5 / í’€í”¼ / ëª¬ìŠ¤í„° HP ìœ ì§€\n(ë¶€í™œê¶Œ ìš°ì„  ì‚¬ìš©)",[
    {text:"ë¶€í™œ", ok:true, fn:()=>revive()},
    {text:"ë‹«ê¸°", fn:()=>closeModal()}
  ]);
}
function revive(){
  const d = getDaily();
  if(d.revive > 0){
    d.revive -= 1; setDaily(d);
    state.player.hp = getTotalMaxHp();
    logMini("ğŸª½ ë¶€í™œê¶Œ ì‚¬ìš©! í’€í”¼");
    closeModal();
    render();
    autoSave();
    return;
  }
  const p=state.player;
  if(p.dia<5){ logMini("âŒ ë‹¤ì´ì•„ ë¶€ì¡±"); return; }
  p.dia -= 5;
  p.hp = getTotalMaxHp();
  logMini("ğŸ’ ë¶€í™œ í’€í”¼");
  closeModal();
  render();
  autoSave();
}

/* ===== ì´ˆê¸°í™” ===== */
function hardReset(){
  showModal("ì „ì²´ ì´ˆê¸°í™”","ì§„ì§œ ì´ˆê¸°í™” í•˜ì‹œê² ìŠµë‹ˆê¹Œ í˜•ë‹˜!!",[
    {text:"â˜  ì‚­ì œ", danger:true, fn:()=>{
      localStorage.removeItem(SAVE_KEY_MAIN);
      localStorage.removeItem(SAVE_KEY_BACK);
      state=newGameState();
      document.getElementById("log").textContent="";
      logMini("â˜  ì´ˆê¸°í™” ì™„ë£Œ");
      setMonster(1);
      closeModal();
      autoSave();
      render();
      showScreen("battle");
    }},
    {text:"ì·¨ì†Œ", fn:()=>closeModal()}
  ]);
}

/* ===== ì‹œì‘ ===== */
document.addEventListener("DOMContentLoaded", ()=>{
  loadSettings();
  renderSettingsButtons();

  const loaded=loadGame();
  if(loaded){
    state=loaded;
    if(state.settings){
      settings.bgmEnabled=!!state.settings.bgmEnabled;
      settings.sfxEnabled=!!state.settings.sfxEnabled;
    }
    logMini("ğŸ“‚ ë¡œë”© ì™„ë£Œ");
  }else{
    state=newGameState();
    logMini("ğŸ”¥ ì‹œì‘");
  }

  setMonster(state.player.stage);

  if(settings.bgmEnabled) startBgm();

  render();
  autoSave();
});
</script>
</body>
</html>
