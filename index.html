<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>ê°•í•´ì ¸ë°”ë¼</title>
<style>
:root{
--bg:#0f0f14;--card:rgba(255,255,255,.06);
--hp:#44ff6a;--mh:#ff6a6a;--exp:#b88cff;
--gold:#f6c453;--dia:#6fd3ff;
--myth:#ff3a3a;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:#fff;font-family:system-ui}
header{text-align:center;font-weight:900;font-size:24px;padding:12px}
.wrap{max-width:720px;margin:auto;padding:10px 10px 90px}
.card{background:var(--card);padding:12px;border-radius:14px;margin-bottom:10px}
.bar{height:10px;background:#222;border-radius:20px;overflow:hidden}
.fill{height:100%;width:0%}
.hp{background:var(--hp)}
.mh{background:var(--mh)}
.exp{background:var(--exp)}
.btn{width:100%;padding:12px;margin-top:6px;border:0;border-radius:10px;font-weight:700}
.ok{background:#2ecc71}
.gold{background:rgba(246,196,83,.2)}
.dia{background:rgba(111,211,255,.2)}
.tabbar{position:fixed;bottom:0;left:0;right:0;background:#111;padding:8px;display:flex;gap:6px}
.tabbar button{flex:1;padding:10px;border-radius:10px;border:0;background:#222;color:#fff}
.hidden{display:none}
.sprite{width:110px;height:110px;object-fit:contain}
.pet{width:60px;height:60px;object-fit:contain}
.myth{filter:drop-shadow(0 0 10px var(--myth))}
</style>
</head>
<body>
<header>ê°•í•´ì ¸ë°”ë¼</header>
<div class="wrap">

<section id="battle">

<div class="card">
<div>Lv <span id="lv"></span> / 200</div>
<div>Stage <span id="stage"></span></div>
<div id="battleCurrency"></div>
<div>ATK <span id="atk"></span> | CRIT <span id="crit"></span>%</div>
<div>íšŒë³µí…œ <span id="healCount"></span></div>
<div style="margin-top:6px">EXP</div>
<div class="bar"><div id="expBar" class="fill exp"></div></div>
</div>

<div class="card" style="text-align:center">
<div id="petRow"></div>
<img id="playerImg" class="sprite" src="capybara.png">
<div>VS</div>
<img id="monsterImg" class="sprite" src="monster1.png">
<div id="monsterName"></div>
<div class="bar"><div id="monsterHpBar" class="fill mh"></div></div>
<div class="bar"><div id="hpBar" class="fill hp"></div></div>
</div>

<div class="card">
<button class="btn ok" onclick="attack()">ê³µê²©</button>
<button class="btn" onclick="heal()">íšŒë³µ</button>
<button class="btn dia" onclick="revive()">ë¶€í™œ</button>
<div id="log" style="font-size:13px;margin-top:6px"></div>
</div>

</section>

<section id="shop" class="hidden">
<div class="card">
<div>ğŸ’° <span id="gold"></span> | ğŸ’ <span id="dia"></span></div>
<button class="btn ok" onclick="claimDaily()">ì¶œì„ì²´í¬</button>
</div>

<div class="card">
<div>íšŒë³µ ê°€ì± </div>
<button class="btn gold" onclick="healGacha(1)">1íšŒ 1000G</button>
<button class="btn gold" onclick="healGacha(10)">10íšŒ 10000G</button>
</div>

<div class="card">
<div>ì¥ë¹„ ê°€ì± </div>
<button class="btn gold" onclick="gearGacha(1)">1íšŒ 200G</button>
<button class="btn gold" onclick="gearGacha(10)">10íšŒ 2000G</button>
</div>

<div class="card">
<div>ì¹˜ì¥ ê°€ì± </div>
<button class="btn dia" onclick="cosGacha(1)">1íšŒ 5D</button>
<button class="btn dia" onclick="cosGacha(10)">10íšŒ 50D</button>
</div>
</section>

</div>

<div class="tabbar">
<button onclick="show('battle')">ì „íˆ¬</button>
<button onclick="show('shop')">ìƒì </button>
</div>

<script>
const MAX_LV=200;
let state={
lv:1,exp:0,need:20,stage:1,
hp:100,maxHp:100,atk:5,
gold:300,dia:10,healItem:0,
monster:{hp:60,max:60,atk:6,boss:false},
pets:[null,null],
mythStone:0,
daily:{last:"",streak:0}
};

function save(){localStorage.setItem("capy_save_v10",JSON.stringify(state))}
function load(){
let s=localStorage.getItem("capy_save_v10");
if(s)state=JSON.parse(s)
}
function show(id){
document.getElementById("battle").classList.add("hidden");
document.getElementById("shop").classList.add("hidden");
document.getElementById(id).classList.remove("hidden");
render();
}

function log(t){document.getElementById("log").innerText=t}

function spawn(){
let boss=state.stage%10===0;
state.monster.boss=boss;
state.monster.max=boss?150+state.stage*15:60+state.stage*8;
state.monster.hp=state.monster.max;
state.monster.atk=boss?15+state.stage:6+state.stage;
document.getElementById("monsterName").innerText=boss?"ë³´ìŠ¤ ë“œë˜ê³¤":"ëª¬ìŠ¤í„°";
document.getElementById("monsterImg").src=boss?"boss.png":"monster1.png";
}

function nextExp(n,l){
if(l<20)return Math.floor(n*1.16+10);
if(l<60)return Math.floor(n*1.11+14);
if(l<120)return Math.floor(n*1.14+18);
return Math.floor(n*1.17+22);
}

function attack(){
if(state.hp<=0)return log("ì‚¬ë§ ìƒíƒœ");
let crit=Math.random()*100<5;
let dmg=crit?state.atk*2:state.atk;
state.monster.hp-=dmg;
log("ê³µê²© -"+dmg+(crit?" (ì¹˜ëª…)":""));
if(state.monster.hp<=0)return win();
let md=state.monster.atk;
md=Math.min(md,Math.floor(state.hp*0.95));
state.hp-=md;
if(state.hp<=0)log("ì‚¬ë§");
render();save();
}

function win(){
let boss=state.monster.boss;
let gold=Math.floor((14+state.stage*3)*(boss?2.5:1));
let exp=Math.floor((12+state.stage*2)*(boss?2:1));
state.gold+=gold;
state.exp+=exp;
state.healItem+=Math.floor(Math.random()*5)+3;
if(boss)state.mythStone+=Math.floor(Math.random()*2)+1;
while(state.exp>=state.need&&state.lv<MAX_LV){
state.exp-=state.need;
state.lv++;
state.need=nextExp(state.need,state.lv);
state.maxHp+=16;
state.atk+=2;
state.hp=state.maxHp;
}
state.stage++;
spawn();
render();save();
}

function heal(){
if(state.healItem<=0)return log("íšŒë³µí…œ ì—†ìŒ");
state.healItem--;
state.hp=Math.min(state.hp+Math.floor(state.maxHp*0.35),state.maxHp);
render();save();
}

function revive(){
if(state.hp>0)return;
if(state.dia>=5){
state.dia-=5;
state.hp=state.maxHp;
render();save();
}
}

function healGacha(n){
let cost=1000*n;
if(state.gold<cost)return log("ê³¨ë“œ ë¶€ì¡±");
state.gold-=cost;
let total=0;
for(let i=0;i<n;i++)total+=Math.floor(Math.random()*5)+3;
state.healItem+=total;
render();save();
}

function gearGacha(n){
let cost=200*n;
if(state.gold<cost)return log("ê³¨ë“œ ë¶€ì¡±");
state.gold-=cost;
state.atk+=n;
render();save();
}

function cosGacha(n){
let cost=5*n;
if(state.dia<cost)return log("ë‹¤ì´ì•„ ë¶€ì¡±");
state.dia-=cost;
render();save();
}

function claimDaily(){
let today=new Date().toDateString();
if(state.daily.last===today)return log("ì´ë¯¸ ë°›ìŒ");
state.daily.last=today;
state.daily.streak++;
if(state.daily.streak>7)state.daily.streak=1;
state.dia+=5*state.daily.streak;
render();save();
}

function render(){
document.getElementById("lv").innerText=state.lv;
document.getElementById("stage").innerText=state.stage;
document.getElementById("atk").innerText=state.atk;
document.getElementById("crit").innerText=5;
document.getElementById("healCount").innerText=state.healItem;
document.getElementById("hpBar").style.width=(state.hp/state.maxHp*100)+"%";
document.getElementById("monsterHpBar").style.width=(state.monster.hp/state.monster.max*100)+"%";
document.getElementById("expBar").style.width=(state.exp/state.need*100)+"%";

document.getElementById("gold").innerText=state.gold;
document.getElementById("dia").innerText=state.dia;

document.getElementById("battleCurrency").innerText="";
}

load();
spawn();
render();
/* =========================
   PART3 - ì°½ê³ /ì¥ë¹„/í«/ì‹ í™” ì‹œìŠ¤í…œ (ì•ˆì • ì••ì¶•ë³¸)
========================= */

if(!state.player.inventory){
  state.player.inventory = [];
}
if(!state.player.pets){
  state.player.pets = [];
}
if(!state.player.equip){
  state.player.equip = {
    weapon:null,
    armor:null,
    cosmetic:null,
    pet1:null,
    pet2:null
  };
}
if(!state.player.mythicStone){
  state.player.mythicStone = 0;
}

/* -----------------------
   ë“±ê¸‰ ì„¤ì •
----------------------- */
const RARITY_COLOR = {
  normal:"#aaa",
  rare:"#4da6ff",
  epic:"#c266ff",
  legend:"#ffcc33",
  mythic:"#ff3a3a"
};

/* -----------------------
   ì°½ê³  UI ë Œë”
----------------------- */
function renderWarehouse(){

  const screen = document.getElementById("screenWarehouse");

  let html = `
  <div class="card">
    <b>ğŸ’ ì¥ë¹„</b><br><br>
  `;

  if(state.player.inventory.length===0){
    html += `<div class="tiny">ì¥ë¹„ ì—†ìŒ</div>`;
  }

  state.player.inventory.forEach((item,i)=>{

    html += `
    <div style="border:1px solid #333;padding:8px;margin-bottom:8px;border-radius:8px;">
      <div style="color:${RARITY_COLOR[item.rarity]}">
        ${item.name} (${item.rarity})
        ${item.enhance?` +${item.enhance}`:""}
        ${item.mythicLevel?` ğŸ”¥${item.mythicLevel}`:""}
      </div>
      <div class="tiny">ATK +${item.atk}</div>
      <button class="btn" onclick="equipItem(${i})">ì¥ì°©</button>
      ${item.rarity==="legend" ? `<button class="btn" onclick="enhanceLegend(${i})">ê°•í™”</button>`:""}
      ${item.rarity==="legend" && item.enhance>=5 ? `<button class="btn btnDia" onclick="evolveMythic(${i})">ì‹ í™”ì§„í™”(50ğŸ’)</button>`:""}
      ${item.rarity==="mythic" ? `<button class="btn btnGold" onclick="enhanceMythicItem(${i})">ì‹ í™”ê°•í™”(1ì„)</button>`:""}
    </div>
    `;
  });

  html += `</div>`;

  /* í« */
  html += `
  <div class="card">
    <b>ğŸ¾ í«</b><br><br>
  `;

  if(state.player.pets.length===0){
    html += `<div class="tiny">í« ì—†ìŒ</div>`;
  }

  state.player.pets.forEach((pet,i)=>{
    html += `
    <div style="border:1px solid #333;padding:8px;margin-bottom:8px;border-radius:8px;">
      <div>${pet.name} (${pet.rarity})</div>
      <div class="tiny">ATK +${pet.atk} HP +${pet.hp}</div>
      <button class="btn" onclick="equipPet(${i},1)">ìŠ¬ë¡¯1</button>
      <button class="btn" onclick="equipPet(${i},2)">ìŠ¬ë¡¯2</button>
    </div>
    `;
  });

  html += `</div>`;

  screen.innerHTML = html;
}

/* -----------------------
   ì¥ì°©
----------------------- */
function equipItem(index){
  const item = state.player.inventory[index];
  state.player.equip.weapon = item;
  logMini(`âš” ${item.name} ì¥ì°©`);
  render();
  renderWarehouse();
  autoSave();
}

/* -----------------------
   ì „ì„¤ ê°•í™”
----------------------- */
function enhanceLegend(index){
  const item = state.player.inventory[index];
  if(item.rarity!=="legend") return;

  item.enhance = (item.enhance||0)+1;
  item.atk = Math.floor(item.atk*1.1);
  logMini(`âœ¨ ì „ì„¤ ê°•í™” +${item.enhance}`);
  renderWarehouse();
  render();
  autoSave();
}

/* -----------------------
   ì‹ í™” ì§„í™”
----------------------- */
function evolveMythic(index){
  const item = state.player.inventory[index];
  if(state.player.dia<50){
    logMini("ğŸ’ ë¶€ì¡±");
    return;
  }
  state.player.dia-=50;
  item.rarity="mythic";
  item.enhance=0;
  item.mythicLevel=0;
  item.atk=Math.floor(item.atk*1.5);
  logMini(`ğŸ”¥ ${item.name} ì‹ í™” ì§„í™”`);
  renderWarehouse();
  render();
  autoSave();
}

/* -----------------------
   ì‹ í™” ê°•í™”
----------------------- */
function enhanceMythicItem(index){
  const item = state.player.inventory[index];
  if(state.player.mythicStone<=0){
    logMini("âŒ ì‹ í™”ì„ ë¶€ì¡±");
    return;
  }
  state.player.mythicStone--;
  item.mythicLevel = (item.mythicLevel||0)+1;
  item.atk = Math.floor(item.atk*1.12);
  logMini(`ğŸ’ ì‹ í™” ê°•í™” +${item.mythicLevel}`);
  renderWarehouse();
  render();
  autoSave();
}

/* -----------------------
   í« ì¥ì°©
----------------------- */
function equipPet(index,slot){
  const pet = state.player.pets[index];

  if(slot===1 && state.player.level<40){
    logMini("Lv40 í•„ìš”");
    return;
  }
  if(slot===2 && state.player.level<120){
    logMini("Lv120 í•„ìš”");
    return;
  }

  state.player.equip["pet"+slot] = pet;
  logMini(`ğŸ¾ ${pet.name} ìŠ¬ë¡¯${slot} ì¥ì°©`);
  render();
  renderWarehouse();
  autoSave();
}

/* -----------------------
   ì „íˆ¬ ëŠ¥ë ¥ì¹˜ ë°˜ì˜
----------------------- */
const _getTotalAtk2 = getTotalAtk;
getTotalAtk = function(){
  let base = _getTotalAtk2();
  if(state.player.equip.weapon){
    base += state.player.equip.weapon.atk;
  }
  if(state.player.equip.pet1){
    base += state.player.equip.pet1.atk;
  }
  if(state.player.equip.pet2){
    base += state.player.equip.pet2.atk;
  }
  return base;
};

/* -----------------------
   í™”ë©´ ì „í™˜ì‹œ ì°½ê³  ë Œë”
----------------------- */
const _showScreen2 = showScreen;
showScreen = function(name){
  _showScreen2(name);
  if(name==="warehouse"){
    renderWarehouse();
  }
};

</script>
</body>
</html>
